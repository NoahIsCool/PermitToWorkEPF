{"ast":null,"code":"import _regeneratorRuntime from\"/Users/skylarsmith/PermitToWorkEPF/ClientApp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/skylarsmith/PermitToWorkEPF/ClientApp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/skylarsmith/PermitToWorkEPF/ClientApp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/skylarsmith/PermitToWorkEPF/ClientApp/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{UserManager,WebStorageStateStore}from'oidc-client';import{ApplicationPaths,ApplicationName}from'./ApiAuthorizationConstants';export var AuthorizeService=/*#__PURE__*/function(){function AuthorizeService(){_classCallCheck(this,AuthorizeService);this._callbacks=[];this._nextSubscriptionId=0;this._user=null;this._isAuthenticated=false;this._popUpDisabled=true;}_createClass(AuthorizeService,[{key:\"isAuthenticated\",value:function(){var _isAuthenticated=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var user;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return this.getUser();case 2:user=_context.sent;return _context.abrupt(\"return\",!!user);case 4:case\"end\":return _context.stop();}}},_callee,this);}));function isAuthenticated(){return _isAuthenticated.apply(this,arguments);}return isAuthenticated;}()},{key:\"getUser\",value:function(){var _getUser=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var user;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(this._user&&this._user.profile)){_context2.next=2;break;}return _context2.abrupt(\"return\",this._user.profile);case 2:_context2.next=4;return this.ensureUserManagerInitialized();case 4:_context2.next=6;return this.userManager.getUser();case 6:user=_context2.sent;return _context2.abrupt(\"return\",user&&user.profile);case 8:case\"end\":return _context2.stop();}}},_callee2,this);}));function getUser(){return _getUser.apply(this,arguments);}return getUser;}()},{key:\"getAccessToken\",value:function(){var _getAccessToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var user;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.ensureUserManagerInitialized();case 2:_context3.next=4;return this.userManager.getUser();case 4:user=_context3.sent;return _context3.abrupt(\"return\",user&&user.access_token);case 6:case\"end\":return _context3.stop();}}},_callee3,this);}));function getAccessToken(){return _getAccessToken.apply(this,arguments);}return getAccessToken;}()// We try to authenticate the user in three different ways:\n// 1) We try to see if we can authenticate the user silently. This happens\n//    when the user is already logged in on the IdP and is done using a hidden iframe\n//    on the client.\n// 2) We try to authenticate the user using a PopUp Window. This might fail if there is a\n//    Pop-Up blocker or the user has disabled PopUps.\n// 3) If the two methods above fail, we redirect the browser to the IdP to perform a traditional\n//    redirect flow.\n},{key:\"signIn\",value:function(){var _signIn=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(state){var silentUser,popUpUser;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return this.ensureUserManagerInitialized();case 2:_context4.prev=2;_context4.next=5;return this.userManager.signinSilent(this.createArguments());case 5:silentUser=_context4.sent;this.updateState(silentUser);return _context4.abrupt(\"return\",this.success(state));case 10:_context4.prev=10;_context4.t0=_context4[\"catch\"](2);// User might not be authenticated, fallback to popup authentication\nconsole.log(\"Silent authentication error: \",_context4.t0);_context4.prev=13;if(!this._popUpDisabled){_context4.next=16;break;}throw new Error('Popup disabled. Change \\'AuthorizeService.js:AuthorizeService._popupDisabled\\' to false to enable it.');case 16:_context4.next=18;return this.userManager.signinPopup(this.createArguments());case 18:popUpUser=_context4.sent;this.updateState(popUpUser);return _context4.abrupt(\"return\",this.success(state));case 23:_context4.prev=23;_context4.t1=_context4[\"catch\"](13);if(!(_context4.t1.message===\"Popup window closed\")){_context4.next=29;break;}return _context4.abrupt(\"return\",this.error(\"The user closed the window.\"));case 29:if(!this._popUpDisabled){console.log(\"Popup authentication error: \",_context4.t1);}case 30:_context4.prev=30;_context4.next=33;return this.userManager.signinRedirect(this.createArguments(state));case 33:return _context4.abrupt(\"return\",this.redirect());case 36:_context4.prev=36;_context4.t2=_context4[\"catch\"](30);console.log(\"Redirect authentication error: \",_context4.t2);return _context4.abrupt(\"return\",this.error(_context4.t2));case 40:case\"end\":return _context4.stop();}}},_callee4,this,[[2,10],[13,23],[30,36]]);}));function signIn(_x){return _signIn.apply(this,arguments);}return signIn;}()},{key:\"completeSignIn\",value:function(){var _completeSignIn=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(url){var user;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;_context5.next=3;return this.ensureUserManagerInitialized();case 3:_context5.next=5;return this.userManager.signinCallback(url);case 5:user=_context5.sent;this.updateState(user);return _context5.abrupt(\"return\",this.success(user&&user.state));case 10:_context5.prev=10;_context5.t0=_context5[\"catch\"](0);console.log('There was an error signing in: ',_context5.t0);return _context5.abrupt(\"return\",this.error('There was an error signing in.'));case 14:case\"end\":return _context5.stop();}}},_callee5,this,[[0,10]]);}));function completeSignIn(_x2){return _completeSignIn.apply(this,arguments);}return completeSignIn;}()// We try to sign out the user in two different ways:\n// 1) We try to do a sign-out using a PopUp Window. This might fail if there is a\n//    Pop-Up blocker or the user has disabled PopUps.\n// 2) If the method above fails, we redirect the browser to the IdP to perform a traditional\n//    post logout redirect flow.\n},{key:\"signOut\",value:function(){var _signOut=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(state){return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return this.ensureUserManagerInitialized();case 2:_context6.prev=2;if(!this._popUpDisabled){_context6.next=5;break;}throw new Error('Popup disabled. Change \\'AuthorizeService.js:AuthorizeService._popupDisabled\\' to false to enable it.');case 5:_context6.next=7;return this.userManager.signoutPopup(this.createArguments());case 7:this.updateState(undefined);return _context6.abrupt(\"return\",this.success(state));case 11:_context6.prev=11;_context6.t0=_context6[\"catch\"](2);console.log(\"Popup signout error: \",_context6.t0);_context6.prev=14;_context6.next=17;return this.userManager.signoutRedirect(this.createArguments(state));case 17:return _context6.abrupt(\"return\",this.redirect());case 20:_context6.prev=20;_context6.t1=_context6[\"catch\"](14);console.log(\"Redirect signout error: \",_context6.t1);return _context6.abrupt(\"return\",this.error(_context6.t1));case 24:case\"end\":return _context6.stop();}}},_callee6,this,[[2,11],[14,20]]);}));function signOut(_x3){return _signOut.apply(this,arguments);}return signOut;}()},{key:\"completeSignOut\",value:function(){var _completeSignOut=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(url){var response;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return this.ensureUserManagerInitialized();case 2:_context7.prev=2;_context7.next=5;return this.userManager.signoutCallback(url);case 5:response=_context7.sent;this.updateState(null);return _context7.abrupt(\"return\",this.success(response&&response.data));case 10:_context7.prev=10;_context7.t0=_context7[\"catch\"](2);console.log(\"There was an error trying to log out '\".concat(_context7.t0,\"'.\"));return _context7.abrupt(\"return\",this.error(_context7.t0));case 14:case\"end\":return _context7.stop();}}},_callee7,this,[[2,10]]);}));function completeSignOut(_x4){return _completeSignOut.apply(this,arguments);}return completeSignOut;}()},{key:\"updateState\",value:function updateState(user){this._user=user;this._isAuthenticated=!!this._user;this.notifySubscribers();}},{key:\"subscribe\",value:function subscribe(callback){this._callbacks.push({callback:callback,subscription:this._nextSubscriptionId++});return this._nextSubscriptionId-1;}},{key:\"unsubscribe\",value:function unsubscribe(subscriptionId){var subscriptionIndex=this._callbacks.map(function(element,index){return element.subscription===subscriptionId?{found:true,index:index}:{found:false};}).filter(function(element){return element.found===true;});if(subscriptionIndex.length!==1){throw new Error(\"Found an invalid number of subscriptions \".concat(subscriptionIndex.length));}this._callbacks.splice(subscriptionIndex[0].index,1);}},{key:\"notifySubscribers\",value:function notifySubscribers(){for(var i=0;i<this._callbacks.length;i++){var callback=this._callbacks[i].callback;callback();}}},{key:\"createArguments\",value:function createArguments(state){return{useReplaceToNavigate:true,data:state};}},{key:\"error\",value:function error(message){return{status:AuthenticationResultStatus.Fail,message:message};}},{key:\"success\",value:function success(state){return{status:AuthenticationResultStatus.Success,state:state};}},{key:\"redirect\",value:function redirect(){return{status:AuthenticationResultStatus.Redirect};}},{key:\"ensureUserManagerInitialized\",value:function(){var _ensureUserManagerInitialized=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(){var _this=this;var response,settings;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(!(this.userManager!==undefined)){_context9.next=2;break;}return _context9.abrupt(\"return\");case 2:_context9.next=4;return fetch(ApplicationPaths.ApiAuthorizationClientConfigurationUrl);case 4:response=_context9.sent;if(response.ok){_context9.next=7;break;}throw new Error(\"Could not load settings for '\".concat(ApplicationName,\"'\"));case 7:_context9.next=9;return response.json();case 9:settings=_context9.sent;settings.automaticSilentRenew=true;settings.includeIdTokenInSilentRenew=true;settings.userStore=new WebStorageStateStore({prefix:ApplicationName});this.userManager=new UserManager(settings);this.userManager.events.addUserSignedOut(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return _this.userManager.removeUser();case 2:_this.updateState(undefined);case 3:case\"end\":return _context8.stop();}}},_callee8);})));case 15:case\"end\":return _context9.stop();}}},_callee9,this);}));function ensureUserManagerInitialized(){return _ensureUserManagerInitialized.apply(this,arguments);}return ensureUserManagerInitialized;}()}],[{key:\"instance\",get:function get(){return authService;}}]);return AuthorizeService;}();var authService=new AuthorizeService();export default authService;export var AuthenticationResultStatus={Redirect:'redirect',Success:'success',Fail:'fail'};","map":{"version":3,"sources":["/Users/skylarsmith/PermitToWorkEPF/ClientApp/src/components/api-authorization/AuthorizeService.js"],"names":["UserManager","WebStorageStateStore","ApplicationPaths","ApplicationName","AuthorizeService","_callbacks","_nextSubscriptionId","_user","_isAuthenticated","_popUpDisabled","getUser","user","profile","ensureUserManagerInitialized","userManager","access_token","state","signinSilent","createArguments","silentUser","updateState","success","console","log","Error","signinPopup","popUpUser","message","error","signinRedirect","redirect","url","signinCallback","signoutPopup","undefined","signoutRedirect","signoutCallback","response","data","notifySubscribers","callback","push","subscription","subscriptionId","subscriptionIndex","map","element","index","found","filter","length","splice","i","useReplaceToNavigate","status","AuthenticationResultStatus","Fail","Success","Redirect","fetch","ApiAuthorizationClientConfigurationUrl","ok","json","settings","automaticSilentRenew","includeIdTokenInSilentRenew","userStore","prefix","events","addUserSignedOut","removeUser","authService"],"mappings":"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","sourcesContent":["import { UserManager, WebStorageStateStore } from 'oidc-client';\nimport { ApplicationPaths, ApplicationName } from './ApiAuthorizationConstants';\n\nexport class AuthorizeService {\n    _callbacks = [];\n    _nextSubscriptionId = 0;\n    _user = null;\n    _isAuthenticated = false;\n\n    // By default pop ups are disabled because they don't work properly on Edge.\n    // If you want to enable pop up authentication simply set this flag to false.\n    _popUpDisabled = true;\n\n    async isAuthenticated() {\n        const user = await this.getUser();\n        return !!user;\n    }\n\n    async getUser() {\n        if (this._user && this._user.profile) {\n            return this._user.profile;\n        }\n\n        await this.ensureUserManagerInitialized();\n        const user = await this.userManager.getUser();\n        return user && user.profile;\n    }\n\n    async getAccessToken() {\n        await this.ensureUserManagerInitialized();\n        const user = await this.userManager.getUser();\n        return user && user.access_token;\n    }\n\n    // We try to authenticate the user in three different ways:\n    // 1) We try to see if we can authenticate the user silently. This happens\n    //    when the user is already logged in on the IdP and is done using a hidden iframe\n    //    on the client.\n    // 2) We try to authenticate the user using a PopUp Window. This might fail if there is a\n    //    Pop-Up blocker or the user has disabled PopUps.\n    // 3) If the two methods above fail, we redirect the browser to the IdP to perform a traditional\n    //    redirect flow.\n    async signIn(state) {\n        await this.ensureUserManagerInitialized();\n        try {\n            const silentUser = await this.userManager.signinSilent(this.createArguments());\n            this.updateState(silentUser);\n            return this.success(state);\n        } catch (silentError) {\n            // User might not be authenticated, fallback to popup authentication\n            console.log(\"Silent authentication error: \", silentError);\n\n            try {\n                if (this._popUpDisabled) {\n                    throw new Error('Popup disabled. Change \\'AuthorizeService.js:AuthorizeService._popupDisabled\\' to false to enable it.')\n                }\n\n                const popUpUser = await this.userManager.signinPopup(this.createArguments());\n                this.updateState(popUpUser);\n                return this.success(state);\n            } catch (popUpError) {\n                if (popUpError.message === \"Popup window closed\") {\n                    // The user explicitly cancelled the login action by closing an opened popup.\n                    return this.error(\"The user closed the window.\");\n                } else if (!this._popUpDisabled) {\n                    console.log(\"Popup authentication error: \", popUpError);\n                }\n\n                // PopUps might be blocked by the user, fallback to redirect\n                try {\n                    await this.userManager.signinRedirect(this.createArguments(state));\n                    return this.redirect();\n                } catch (redirectError) {\n                    console.log(\"Redirect authentication error: \", redirectError);\n                    return this.error(redirectError);\n                }\n            }\n        }\n    }\n\n    async completeSignIn(url) {\n        try {\n            await this.ensureUserManagerInitialized();\n            const user = await this.userManager.signinCallback(url);\n            this.updateState(user);\n            return this.success(user && user.state);\n        } catch (error) {\n            console.log('There was an error signing in: ', error);\n            return this.error('There was an error signing in.');\n        }\n    }\n\n    // We try to sign out the user in two different ways:\n    // 1) We try to do a sign-out using a PopUp Window. This might fail if there is a\n    //    Pop-Up blocker or the user has disabled PopUps.\n    // 2) If the method above fails, we redirect the browser to the IdP to perform a traditional\n    //    post logout redirect flow.\n    async signOut(state) {\n        await this.ensureUserManagerInitialized();\n        try {\n            if (this._popUpDisabled) {\n                throw new Error('Popup disabled. Change \\'AuthorizeService.js:AuthorizeService._popupDisabled\\' to false to enable it.')\n            }\n\n            await this.userManager.signoutPopup(this.createArguments());\n            this.updateState(undefined);\n            return this.success(state);\n        } catch (popupSignOutError) {\n            console.log(\"Popup signout error: \", popupSignOutError);\n            try {\n                await this.userManager.signoutRedirect(this.createArguments(state));\n                return this.redirect();\n            } catch (redirectSignOutError) {\n                console.log(\"Redirect signout error: \", redirectSignOutError);\n                return this.error(redirectSignOutError);\n            }\n        }\n    }\n\n    async completeSignOut(url) {\n        await this.ensureUserManagerInitialized();\n        try {\n            const response = await this.userManager.signoutCallback(url);\n            this.updateState(null);\n            return this.success(response && response.data);\n        } catch (error) {\n            console.log(`There was an error trying to log out '${error}'.`);\n            return this.error(error);\n        }\n    }\n\n    updateState(user) {\n        this._user = user;\n        this._isAuthenticated = !!this._user;\n        this.notifySubscribers();\n    }\n\n    subscribe(callback) {\n        this._callbacks.push({ callback, subscription: this._nextSubscriptionId++ });\n        return this._nextSubscriptionId - 1;\n    }\n\n    unsubscribe(subscriptionId) {\n        const subscriptionIndex = this._callbacks\n            .map((element, index) => element.subscription === subscriptionId ? { found: true, index } : { found: false })\n            .filter(element => element.found === true);\n        if (subscriptionIndex.length !== 1) {\n            throw new Error(`Found an invalid number of subscriptions ${subscriptionIndex.length}`);\n        }\n\n        this._callbacks.splice(subscriptionIndex[0].index, 1);\n    }\n\n    notifySubscribers() {\n        for (let i = 0; i < this._callbacks.length; i++) {\n            const callback = this._callbacks[i].callback;\n            callback();\n        }\n    }\n\n    createArguments(state) {\n        return { useReplaceToNavigate: true, data: state };\n    }\n\n    error(message) {\n        return { status: AuthenticationResultStatus.Fail, message };\n    }\n\n    success(state) {\n        return { status: AuthenticationResultStatus.Success, state };\n    }\n\n    redirect() {\n        return { status: AuthenticationResultStatus.Redirect };\n    }\n\n    async ensureUserManagerInitialized() {\n        if (this.userManager !== undefined) {\n            return;\n        }\n\n        let response = await fetch(ApplicationPaths.ApiAuthorizationClientConfigurationUrl);\n        if (!response.ok) {\n            throw new Error(`Could not load settings for '${ApplicationName}'`);\n        }\n\n        let settings = await response.json();\n        settings.automaticSilentRenew = true;\n        settings.includeIdTokenInSilentRenew = true;\n        settings.userStore = new WebStorageStateStore({\n            prefix: ApplicationName\n        });\n\n        this.userManager = new UserManager(settings);\n\n        this.userManager.events.addUserSignedOut(async () => {\n            await this.userManager.removeUser();\n            this.updateState(undefined);\n        });\n    }\n\n    static get instance() { return authService }\n}\n\nconst authService = new AuthorizeService();\n\nexport default authService;\n\nexport const AuthenticationResultStatus = {\n    Redirect: 'redirect',\n    Success: 'success',\n    Fail: 'fail'\n};\n"]},"metadata":{},"sourceType":"module"}